<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OK PLAYLISTS</title>
    <!-- Load Privy SDK with guaranteed onload and onerror callbacks -->
    <script 
        src="https://cdn.jsdelivr.net/npm/@privy-io/react-auth@1.60.2/dist/index.umd.js"
        onload="onPrivyLoad()"
        onerror="onPrivyError()">
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', 'Monaco', monospace; background: #000; color: #fff; line-height: 1.2; font-size: 14px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; padding: 30px 20px; border: 2px solid #fff; background: rgba(255, 255, 255, 0.02); }
        .title { font-size: 48px; font-weight: 400; margin-bottom: 10px; letter-spacing: 8px; }
        .subtitle { font-size: 16px; margin-bottom: 20px; letter-spacing: 2px; }
        .description { font-size: 13px; text-align: left; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        .panel { background: rgba(255, 255, 255, 0.02); border: 1px solid #fff; padding: 20px; text-align: center; margin-bottom: 30px; }
        .connect-btn { background: #666; color: #fff; border: 1px solid #666; padding: 15px 30px; font-family: inherit; font-size: 14px; cursor: pointer; margin: 0 10px 10px 0; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
        .connect-btn:hover { background: #888; border-color: #888; }
        .connect-btn:disabled { background: #333; color: #666; border-color: #333; cursor: not-allowed; }
        .status-line { margin-top: 15px; font-size: 12px; letter-spacing: 1px; }
        .status-connected { color: #fff; }
        .status-disconnected { color: #666; }
        .error, .success { font-size: 12px; margin-top: 10px; }
        .error { color: #ff6666; }
        .success { color: #66ff66; }
        .section { margin-bottom: 20px; border: 1px solid #fff; background: rgba(255, 255, 255, 0.01); }
        .section-header { background: #666; color: #fff; padding: 12px 20px; cursor: pointer; user-select: none; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; position: relative; }
        .section-header::after { content: '[+]'; position: absolute; right: 20px; }
        .section-header.active::after { content: '[-]'; }
        .section-content { padding: 20px; display: none; border-top: 1px solid #333; }
        .section-content.active { display: block; }
        .footer { text-align: center; margin-top: 60px; padding: 30px; border-top: 1px solid #333; font-size: 12px; color: #666; }
        
        /* Profile Section Styles */
        .profile-info { text-align: left; font-size: 12px; line-height: 1.8; }
        .profile-info strong { color: #fff; min-width: 120px; display: inline-block; }
        .profile-info span { color: #ccc; }
        .profile-info .address { font-family: monospace; word-break: break-all; }
        .community-list { list-style: none; padding-left: 20px; margin-top: 5px; }
        .community-list li { color: #66ff66; }
        .community-list li::before { content: '✅'; margin-right: 10px; }
        .community-list .none { color: #999; }
        .community-list .none::before { content: '❌'; }
        .disconnect-btn { padding: 8px 15px; font-size: 12px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">OK PLAYLISTS</div>
            <div class="subtitle">DECENTRALIZED MUSIC PLATFORM</div>
            <div class="description">
                > CONNECT YOUR WALLET AND SPOTIFY TO ACCESS PERSONAL PLAYLISTS<br>
                > EXPLORE NFT MUSIC COMMUNITIES AND CURATED COLLECTIONS<br>
                > MANAGE YOUR MUSICAL IDENTITY IN THE DECENTRALIZED WEB<br>
            </div>
        </div>

        <div class="panel" id="connectionPanel">
            <button class="connect-btn" id="walletBtn" onclick="login()">CONNECT WALLET</button>
            <button class="connect-btn" id="spotifyBtn" onclick="connectSpotify()">CONNECT SPOTIFY</button>
            <div class="status-line" id="connectionStatus">
                WALLET: <span class="status-disconnected">DISCONNECTED</span> | 
                SPOTIFY: <span class="status-disconnected">DISCONNECTED</span>
            </div>
            <div class="error" id="errorMessage" style="display: none;"></div>
            <div class="success" id="successMessage" style="display: none;"></div>
        </div>

        <!-- User Profile Section (hidden by default) -->
        <div class="panel" id="userProfileSection" style="display: none;">
            <div class="profile-info">
                <div><strong>WALLET:</strong> <span id="profileAddress" class="address"></span></div>
                <div><strong>ENS:</strong> <span id="profileEns">Loading...</span></div>
                <div><strong>COMMUNITIES:</strong>
                    <ul id="profileCommunities" class="community-list">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
            <button class="connect-btn disconnect-btn" onclick="logout()">DISCONNECT WALLET</button>
        </div>

        <div class="section">
            <div class="section-header" onclick="toggleSection('playlists')">YOUR PLAYLISTS</div>
            <div class="section-content" id="playlists">
                <div id="playlistGrid" class="playlist-grid">
                    <p style="color: #666; text-align: center; padding: 20px;">
                        > CONNECT YOUR SPOTIFY ACCOUNT TO VIEW PLAYLISTS
                    </p>
                </div>
            </div>
        </div>
        <div class="section">
            <div class="section-header" onclick="toggleSection('communities')">COMMUNITIES</div>
            <div class="section-content" id="communities">
                <div style="padding: 20px; color: #666; text-align: center;">
                    > COMMUNITY PLAYLISTS COMING SOON<br>
                    > CONNECT YOUR WALLET TO CHECK NFT OWNERSHIP
                </div>
            </div>
        </div>

        <div class="footer">OK PLAYLISTS © 2025</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PRIVY_APP_ID = 'cmda3kbo2003al10mcr71ll0z';
        const NFT_COMMUNITIES = [
            { name: 'Bored Ape Yacht Club', contractAddress: '0xBC4CA0EdA7647A8aB7C2061c2E118A18a936f13D' },
            { name: 'Pudgy Penguins', contractAddress: '0xBd3531dA5CF5857e7CfAA92426877b022e612cf8' },
            { name: 'Cool Cats', contractAddress: '0x1A92f7381B9F03921564a437210bB9396471050C' },
        ];

        // --- GLOBAL STATE ---
        let privy;
        let walletConnected = false;
        let spotifyConnected = false;

        // --- PRIVY INITIALIZATION & AUTH ---
        // This function is called directly by the Privy script's `onload` attribute
        function onPrivyLoad() {
            console.log('✅ Privy SDK successfully loaded.');
            initPrivy();
        }

        // This function is called by the Privy script's `onerror` attribute
        function onPrivyError() {
            console.error('❌ Privy SDK failed to load from CDN.');
            showError('Critical Error: Could not load wallet provider. Please check your network and refresh.');
        }

        async function initPrivy() {
            try {
                if (!window.Privy) {
                    // This check is now redundant but kept as a safeguard
                    showError('Privy SDK failed to initialize. Please refresh.');
                    return;
                }
                privy = new window.Privy.PrivyProvider({
                    appId: PRIVY_APP_ID,
                    config: {
                        loginMethods: ['wallet', 'email', 'twitter', 'google'],
                        appearance: { theme: 'dark', accentColor: '#FFFFFF', logo: 'https://your-logo-url.com/logo.png' },
                        embeddedWallets: { createOnLogin: 'users-without-wallets' }
                    },
                });

                // Listen for login and logout events
                privy.on('login', handleLogin);
                privy.on('logout', handleLogout);
                console.log('✅ Privy Provider initialized and event listeners attached.');

            } catch (error) {
                console.error('Privy initialization failed:', error);
                showError('Could not initialize wallet provider.');
            }
        }

        function login() {
            if (privy) {
                privy.login();
            } else {
                showError('Wallet provider is not ready. Please wait a moment and try again.');
            }
        }

        function logout() {
            if (privy) privy.logout();
        }

        function handleLogin(user) {
            walletConnected = true;
            updateConnectionStatus();
            updateUiForLogin(user);
            fetchWalletInfo(user.wallet.address);
        }

        function handleLogout() {
            walletConnected = false;
            updateConnectionStatus();
            updateUiForLogout();
        }

        // --- DATA FETCHING (ENS, NFTs) ---
        async function fetchWalletInfo(address) {
            // Reset UI
            document.getElementById('profileEns').textContent = 'Loading...';
            document.getElementById('profileCommunities').innerHTML = '<li>Loading...</li>';
            
            // Fetch in parallel
            await Promise.all([
                fetchEnsName(address),
                fetchNftCommunities(address)
            ]);
        }

        async function fetchEnsName(address) {
            try {
                const response = await fetch('/api/rpc-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_call',
                        params: [{
                            to: '0x00000000000C2E074eC69A0dFb2997BA6C7d2e1e', // ENS Universal Resolver
                            data: '0x55968996' + address.substring(2).padStart(64, '0')
                        }, 'latest'],
                        id: 1
                    })
                });
                const data = await response.json();
                if (data.result && data.result !== '0x') {
                    const ensName = new TextDecoder().decode(Buffer.from(data.result.substring(2), 'hex')).replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
                    document.getElementById('profileEns').textContent = ensName || 'No ENS Name';
                } else {
                    document.getElementById('profileEns').textContent = 'No ENS Name';
                }
            } catch (error) {
                console.error('Error fetching ENS name:', error);
                document.getElementById('profileEns').textContent = 'Error';
            }
        }

        async function fetchNftCommunities(address) {
            const communitiesList = document.getElementById('profileCommunities');
            communitiesList.innerHTML = '';
            let ownedCommunities = [];

            for (const community of NFT_COMMUNITIES) {
                try {
                    const response = await fetch('/api/rpc-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_call',
                            params: [{
                                to: community.contractAddress,
                                data: '0x70a08231' + '000000000000000000000000' + address.substring(2)
                            }, 'latest'],
                            id: 1
                        })
                    });
                    const data = await response.json();
                    const balance = parseInt(data.result, 16);
                    if (balance > 0) {
                        ownedCommunities.push(community.name);
                    }
                } catch (error) {
                    console.error(`Error checking balance for ${community.name}:`, error);
                }
            }

            if (ownedCommunities.length > 0) {
                ownedCommunities.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    communitiesList.appendChild(li);
                });
            } else {
                communitiesList.innerHTML = '<li class="none">No communities found.</li>';
            }
        }

        // --- UI UPDATES ---
        function updateUiForLogin(user) {
            document.getElementById('connectionPanel').style.display = 'none';
            document.getElementById('userProfileSection').style.display = 'block';
            document.getElementById('profileAddress').textContent = user.wallet.address;
        }

        function updateUiForLogout() {
            document.getElementById('connectionPanel').style.display = 'block';
            document.getElementById('userProfileSection').style.display = 'none';
        }

        function updateConnectionStatus() {
            const walletStatus = walletConnected ? 'CONNECTED' : 'DISCONNECTED';
            const spotifyStatus = spotifyConnected ? 'CONNECTED' : 'DISCONNECTED';
            const walletClass = walletConnected ? 'status-connected' : 'status-disconnected';
            const spotifyClass = spotifyConnected ? 'status-connected' : 'status-disconnected';
            document.getElementById('connectionStatus').innerHTML = 
                `WALLET: <span class="${walletClass}">${walletStatus}</span> | SPOTIFY: <span class="${spotifyClass}">${spotifyStatus}</span>`;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 8000);
            console.error('Error:', message);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            errorEl.style.display = 'none';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 5000);
            console.log('Success:', message);
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
            } else {
                content.classList.add('active');
                header.classList.add('active');
            }
        }

        function connectSpotify() {
            try {
                document.getElementById('spotifyBtn').textContent = 'CONNECTING...';
                document.getElementById('spotifyBtn').disabled = true;
                console.log('🔄 Redirecting to Spotify auth...');
                
                window.location.href = '/api/auth/spotify';
                
            } catch (error) {
                console.error('❌ Spotify connection failed:', error);
                showError('Spotify connection failed: ' + error.message);
                document.getElementById('spotifyBtn').textContent = 'CONNECT SPOTIFY';
                document.getElementById('spotifyBtn').disabled = false;
            }
        }

        async function logoutSpotify() {
            try {
                const response = await fetch('/api/spotify/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    spotifyConnected = false;
                    
                    document.getElementById('spotifyBtn').style.display = 'inline-block';
                    document.getElementById('logoutBtn').style.display = 'none';
                    document.getElementById('spotifyBtn').textContent = 'CONNECT SPOTIFY';
                    document.getElementById('spotifyBtn').disabled = false;
                    
                    document.getElementById('playlistGrid').innerHTML = 
                        '<p style="color: #666; text-align: center; padding: 20px;">> CONNECT YOUR SPOTIFY ACCOUNT TO VIEW PLAYLISTS</p>';
                    
                    updateConnectionStatus();
                    showSuccess('Logged out from Spotify');
                }
            } catch (error) {
                showError('Logout failed: ' + error.message);
            }
        }

        async function fetchPlaylists() {
            const playlistGrid = document.getElementById('playlistGrid');
            playlistGrid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">🔄 Loading playlists...</p>';
            
            try {
                console.log('Frontend: Attempting to fetch playlists from /api/spotify/playlists...');
                const response = await fetch('/api/spotify/playlists');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Frontend: Playlists API response not OK. Status:', response.status, 'Body:', errorText);
                    
                    if (response.status === 401) {
                        showError('Spotify session expired or not authenticated. Please reconnect Spotify.');
                        spotifyConnected = false;
                        updateConnectionStatus();
                        document.getElementById('spotifyBtn').style.display = 'inline-block';
                        document.getElementById('logoutBtn').style.display = 'none';
                        document.getElementById('spotifyBtn').textContent = 'CONNECT SPOTIFY';
                        document.getElementById('spotifyBtn').disabled = false;
                        playlistGrid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">> CONNECT YOUR SPOTIFY ACCOUNT TO VIEW PLAYLISTS</p>';
                        return;
                    }
                    throw new Error(`Failed to fetch playlists: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Frontend: Playlists fetched successfully:', data.playlists);

                if (data.playlists && data.playlists.length > 0) {
                    playlistGrid.innerHTML = '';
                    data.playlists.forEach(playlist => {
                        const playlistCardHtml = `
                            <div class="playlist-card" data-playlist-id="${playlist.id}" onclick="togglePlaylistDetails(this, '${playlist.id}')">
                                <div class="playlist-collapsed-view">
                                    <img src="${playlist.cover || '/placeholder.svg?height=50&width=50&text=No+Image'}" alt="${playlist.name} cover">
                                    <div class="playlist-info">
                                        <h5>${playlist.name}</h5>
                                        <p>${playlist.tracks} tracks</p>
                                    </div>
                                </div>
                                <div class="playlist-expanded-details">
                                    <p><strong>Description:</strong> <span class="playlist-description">${playlist.description || 'N/A'}</span></p>
                                    <p><strong>Total Duration:</strong> <span class="playlist-duration">Loading...</span></p>
                                    <p><strong>Songs:</strong></p>
                                    <ul class="playlist-songs">
                                        <li>Loading songs...</li>
                                    </ul>
                                    <p><a href="${playlist.spotifyUrl}" target="_blank">View on Spotify</a></p>
                                </div>
                            </div>
                        `;
                        playlistGrid.innerHTML += playlistCardHtml;
                    });
                    toggleSection('playlists');
                } else {
                    playlistGrid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">> No public playlists found or created by you.</p>';
                }

            } catch (error) {
                console.error('Frontend: Error fetching playlists:', error);
                showError('Failed to load playlists: ' + error.message);
                playlistGrid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">> Error loading playlists. Please try again.</p>';
            }
        }

        async function togglePlaylistDetails(cardElement, playlistId) {
            const expandedDetails = cardElement.querySelector('.playlist-expanded-details');
            
            if (cardElement.classList.contains('expanded')) {
                cardElement.classList.remove('expanded');
            } else {
                cardElement.classList.add('expanded');
                
                if (expandedDetails.dataset.loaded !== 'true') {
                    try {
                        expandedDetails.innerHTML = '<p style="text-align: center;">🔄 Loading details...</p>';
                        console.log(`Frontend: Fetching details for playlist ID: ${playlistId}`);
                        const response = await fetch(`/api/spotify/playlist/${playlistId}`);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Failed to fetch playlist details: ${response.status} - ${errorText}`);
                        }

                        const details = await response.json();
                        console.log('Frontend: Playlist details fetched:', details);

                        let tracksHtml = '';
                        if (details.tracks && details.tracks.length > 0) {
                            tracksHtml = details.tracks.map(track => `<li>${track.name} - ${track.artist}</li>`).join('');
                        } else {
                            tracksHtml = '<li>No songs found.</li>';
                        }

                        expandedDetails.innerHTML = `
                            <p><strong>Description:</strong> ${details.description || 'N/A'}</p>
                            <p><strong>Total Duration:</strong> ${details.totalDuration || 'N/A'}</p>
                            <p><strong>Songs (${details.totalTracks}):</strong></p>
                            <ul>${tracksHtml}</ul>
                            <p><a href="${details.spotifyUrl}" target="_blank">View on Spotify</a></p>
                        `;
                        expandedDetails.dataset.loaded = 'true';
                    } catch (error) {
                        console.error('Frontend: Error fetching playlist details:', error);
                        expandedDetails.innerHTML = `<p style="color: #ff6666;">❌ Failed to load details: ${error.message}</p>`;
                    }
                }
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // The DOM is ready. Privy will initialize itself via the `onload` callback.
            // We only need to handle things that are not dependent on Privy here.
            updateConnectionStatus();
            
            // Handle Spotify redirect logic
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('spotify_connected') === 'true') {
                spotifyConnected = true;
                // You might want to update UI elements related to spotify here
                document.getElementById('spotifyBtn').style.display = 'none';
                // Assuming you add a logout button for spotify
                // document.getElementById('spotifyLogoutBtn').style.display = 'block';
                updateConnectionStatus();
                showSuccess('✅ Spotify connected successfully!');
                fetchPlaylists();
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('error')) {
                showError(`Authentication failed: ${urlParams.get('error')}`);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
